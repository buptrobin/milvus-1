# Natural Language Query Agent for Pampers Metadata

ä¸€ä¸ªåŸºäºŽè‡ªç„¶è¯­è¨€å¤„ç†çš„æ™ºèƒ½æŸ¥è¯¢ä»£ç†ï¼Œèƒ½å¤Ÿé€šè¿‡è‡ªç„¶è¯­è¨€æŸ¥è¯¢Pampersæ•°æ®åº“ä¸­çš„å±žæ€§å’Œäº‹ä»¶ä¿¡æ¯ã€‚

## ðŸŽ¯ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- **ä¸‰é˜¶æ®µæŸ¥è¯¢å¤„ç†**:
  1. ä¸ªäººå±žæ€§æŸ¥è¯¢ (PROFILEç±»åž‹)
  2. äº‹ä»¶æŸ¥è¯¢ (Events)
  3. äº‹ä»¶å±žæ€§æŸ¥è¯¢ (EVENTç±»åž‹ï¼ŒåŸºäºŽæ‰¾åˆ°çš„äº‹ä»¶)

- **æ™ºèƒ½è¯­è¨€ç†è§£**:
  - ä¸­è‹±æ–‡æ··åˆæŸ¥è¯¢æ”¯æŒ
  - æŸ¥è¯¢æ„å›¾è‡ªåŠ¨è¯†åˆ«
  - å…³é”®è¯æå–å’Œå®žä½“è¯†åˆ«
  - æ­§ä¹‰æ£€æµ‹å’Œæ¾„æ¸…å»ºè®®

- **é«˜æ€§èƒ½æœç´¢**:
  - BGE-M3å¤šè¯­è¨€åµŒå…¥æ¨¡åž‹
  - ä½™å¼¦ç›¸ä¼¼åº¦è¯­ä¹‰æœç´¢
  - æ™ºèƒ½ç›¸ä¼¼åº¦é˜ˆå€¼è°ƒæ•´
  - ç»“æžœæŽ’åºå’Œè¿‡æ»¤

## ðŸ—ï¸ ç³»ç»Ÿæž¶æž„

```
è‡ªç„¶è¯­è¨€æŸ¥è¯¢ä»£ç†
â”œâ”€â”€ é…ç½®ç®¡ç† (config.py)
â”œâ”€â”€ Milvuså®¢æˆ·ç«¯ (milvus_client.py)
â”œâ”€â”€ åµŒå…¥æ¨¡åž‹ç®¡ç† (embedding_manager.py)
â”œâ”€â”€ æŸ¥è¯¢å¤„ç†å™¨ (query_processor.py)
â”œâ”€â”€ ç»“æžœåˆ†æžå™¨ (result_analyzer.py)
â”œâ”€â”€ ä¸»ä»£ç†ç±» (nl_query_agent.py)
â”œâ”€â”€ å¼‚å¸¸å¤„ç† (exceptions.py)
â”œâ”€â”€ æ—¥å¿—é…ç½® (logging_config.py)
â””â”€â”€ å·¥å…·å‡½æ•° (utils.py)
```

## ðŸš€ å¿«é€Ÿå¼€å§‹

### 1. çŽ¯å¢ƒå‡†å¤‡

ç¡®ä¿å·²å®‰è£…æ‰€éœ€ä¾èµ–ï¼š

```bash
# å®‰è£…æ‰€æœ‰ä¾èµ–
uv sync

# å®‰è£…MLä¾èµ– (åŒ…å«BGE-M3æ¨¡åž‹)
uv sync --extra ml
```

### 2. é…ç½®çŽ¯å¢ƒ

åˆ›å»º `.env` æ–‡ä»¶ (å¯é€‰):

```env
# Milvusé…ç½®
MILVUS_HOST=172.28.9.45
MILVUS_PORT=19530
MILVUS_DATABASE=default

# é›†åˆé…ç½®
METADATA_COLLECTION=Pampers_metadata
EVENT_COLLECTION=Pampers_Event_metadata

# åµŒå…¥æ¨¡åž‹é…ç½®
EMBEDDING_MODEL=BAAI/bge-m3
USE_FP16=true
BATCH_SIZE=128

# æœç´¢é…ç½®
SIMILARITY_THRESHOLD=0.65
SCORE_GAP_THRESHOLD=0.08

# æ—¥å¿—é…ç½®
LOG_LEVEL=INFO
ENABLE_CACHE=true
```

### 3. è¿è¡Œä»£ç†

#### äº¤äº’æ¨¡å¼
```bash
python natural_language_agent.py
```

#### å•æ¬¡æŸ¥è¯¢æ¨¡å¼
```bash
python natural_language_agent.py -q "ç”¨æˆ·çš„å¹´é¾„ä¿¡æ¯"
```

#### è°ƒè¯•æ¨¡å¼
```bash
python natural_language_agent.py --debug
```

### 4. æµ‹è¯•ç³»ç»Ÿ
```bash
python test_agent.py
```

## ðŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### æŸ¥è¯¢ç¤ºä¾‹

1. **ä¸ªäººå±žæ€§æŸ¥è¯¢**:
   - "ç”¨æˆ·çš„å¹´é¾„ä¿¡æ¯"
   - "ä¼šå‘˜çš„æ‰‹æœºå·ç "
   - "å®¢æˆ·æ³¨å†Œæ—¶é—´"
   - "member_idå­—æ®µ"

2. **äº‹ä»¶æŸ¥è¯¢**:
   - "ç§¯åˆ†ç›¸å…³çš„äº‹ä»¶"
   - "è´­ä¹°è®¢å•äº‹ä»¶"
   - "ä¼šå‘˜ç»‘å®šæ´»åŠ¨"
   - "å…‘æ¢ç¤¼å“è®°å½•"

3. **äº‹ä»¶å±žæ€§æŸ¥è¯¢**:
   - "ç§¯åˆ†å˜åŒ–äº‹ä»¶ä¸­çš„æ—¶é—´å­—æ®µ"
   - "è®¢å•é‡‘é¢ç›¸å…³å±žæ€§"
   - "å…‘æ¢æ¸ é“ä¿¡æ¯"

### ç¼–ç¨‹æŽ¥å£

```python
from src import NaturalLanguageQueryAgent

# åˆå§‹åŒ–ä»£ç†
agent = NaturalLanguageQueryAgent()

# å¤„ç†æŸ¥è¯¢
result = agent.process_query("ç”¨æˆ·çš„å¹´é¾„ä¿¡æ¯")

# æŸ¥çœ‹ç»“æžœ
print(f"æŸ¥è¯¢: {result.query}")
print(f"ç½®ä¿¡åº¦: {result.confidence_score}")
print(f"ç»“æžœæ•°: {result.total_results}")

# ä¸ªäººå±žæ€§ç»“æžœ
for attr in result.profile_attributes:
    print(f"å±žæ€§: {attr.source_name}.{attr.field_name}")
    print(f"ç›¸ä¼¼åº¦: {attr.score}")
    print(f"æè¿°: {attr.explanation}")

# äº‹ä»¶ç»“æžœ
for event in result.events:
    print(f"äº‹ä»¶: {event.event_name}")
    print(f"ç›¸ä¼¼åº¦: {event.score}")

# äº‹ä»¶å±žæ€§ç»“æžœ
for attr in result.event_attributes:
    print(f"äº‹ä»¶å±žæ€§: {attr.source_name}.{attr.field_name}")
    print(f"ç›¸ä¼¼åº¦: {attr.score}")
```

## âš™ï¸ é…ç½®è¯´æ˜Ž

### Milvusé…ç½®
- `host`: MilvusæœåŠ¡å™¨åœ°å€
- `port`: MilvusæœåŠ¡å™¨ç«¯å£
- `database`: æ•°æ®åº“åç§°
- `timeout`: è¿žæŽ¥è¶…æ—¶æ—¶é—´

### åµŒå…¥æ¨¡åž‹é…ç½®
- `model_name`: BGE-M3æ¨¡åž‹è·¯å¾„
- `use_fp16`: æ˜¯å¦ä½¿ç”¨åŠç²¾åº¦åŠ é€Ÿ
- `batch_size`: æ‰¹å¤„ç†å¤§å°
- `max_length`: æœ€å¤§æ–‡æœ¬é•¿åº¦

### æœç´¢é…ç½®
- `similarity_threshold`: ç›¸ä¼¼åº¦é˜ˆå€¼
- `score_gap_threshold`: æ­§ä¹‰æ£€æµ‹é˜ˆå€¼
- `max_results`: æœ€å¤§ç»“æžœæ•°
- `*_search_limit`: å„é˜¶æ®µæœç´¢é™åˆ¶

## ðŸ“Š ç»“æžœè§£é‡Š

### ç½®ä¿¡åº¦ç­‰çº§
- ðŸŸ¢ **é«˜ç½®ä¿¡åº¦** (ç›¸ä¼¼åº¦ > 0.8): ç»“æžœé«˜åº¦ç›¸å…³
- ðŸŸ¡ **ä¸­ç­‰ç½®ä¿¡åº¦** (ç›¸ä¼¼åº¦ 0.6-0.8): ç»“æžœç›¸å…³æ€§ä¸­ç­‰
- ðŸ”´ **ä½Žç½®ä¿¡åº¦** (ç›¸ä¼¼åº¦ < 0.6): ç»“æžœç›¸å…³æ€§è¾ƒä½Ž

### æ­§ä¹‰æ ‡è¯†
- âš ï¸ **å¯èƒ½æœ‰æ­§ä¹‰**: ç³»ç»Ÿæ£€æµ‹åˆ°å¤šä¸ªç›¸ä¼¼çš„ç»“æžœï¼Œå»ºè®®ç»†åŒ–æŸ¥è¯¢

### ç»“æžœç±»åž‹
- **ðŸ‘¤ ä¸ªäººå±žæ€§**: ç”¨æˆ·/ä¼šå‘˜çš„åŸºæœ¬ä¿¡æ¯å­—æ®µ
- **ðŸŽ¬ äº‹ä»¶**: ç³»ç»Ÿä¸­çš„ä¸šåŠ¡äº‹ä»¶
- **ðŸŽ¯ äº‹ä»¶å±žæ€§**: ç‰¹å®šäº‹ä»¶ä¸­çš„å­—æ®µä¿¡æ¯

## ðŸ”§ å¼€å‘å’Œæ‰©å±•

### æ·»åŠ æ–°çš„æŸ¥è¯¢ç±»åž‹

1. åœ¨ `query_processor.py` ä¸­æ·»åŠ æ–°çš„å…³é”®è¯å’Œæ¨¡å¼
2. åœ¨ `milvus_client.py` ä¸­æ·»åŠ æ–°çš„æœç´¢æ–¹æ³•
3. åœ¨ `result_analyzer.py` ä¸­æ·»åŠ æ–°çš„ç»“æžœåˆ†æžé€»è¾‘

### è‡ªå®šä¹‰åµŒå…¥æ¨¡åž‹

```python
from src import EmbeddingConfig, EmbeddingManager

config = EmbeddingConfig(
    model_name="your-custom-model",
    use_fp16=True,
    batch_size=64
)

embedding_manager = EmbeddingManager(config)
```

### è‡ªå®šä¹‰é…ç½®

```python
from src import AgentConfig, load_config

# åŠ è½½è‡ªå®šä¹‰é…ç½®
config = load_config()

# ä¿®æ”¹é…ç½®
config.search.similarity_threshold = 0.7
config.milvus.host = "your-milvus-host"

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®åˆ›å»ºä»£ç†
agent = NaturalLanguageQueryAgent(config)
```

## ðŸ› æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿žæŽ¥å¤±è´¥**:
   - æ£€æŸ¥MilvusæœåŠ¡å™¨æ˜¯å¦è¿è¡Œ
   - éªŒè¯ä¸»æœºå’Œç«¯å£é…ç½®
   - æ£€æŸ¥ç½‘ç»œè¿žæŽ¥

2. **æ¨¡åž‹åŠ è½½å¤±è´¥**:
   - ç¡®ä¿å®‰è£…äº†MLä¾èµ–: `uv sync --extra ml`
   - æ£€æŸ¥æ¨¡åž‹è·¯å¾„æ˜¯å¦æ­£ç¡®
   - éªŒè¯GPU/CUDAè®¾ç½®

3. **æœç´¢æ— ç»“æžœ**:
   - æ£€æŸ¥é›†åˆæ˜¯å¦å­˜åœ¨æ•°æ®
   - è°ƒä½Žç›¸ä¼¼åº¦é˜ˆå€¼
   - å°è¯•ä¸åŒçš„æŸ¥è¯¢è¡¨è¾¾

4. **æ€§èƒ½é—®é¢˜**:
   - å¯ç”¨ç¼“å­˜: `ENABLE_CACHE=true`
   - è°ƒæ•´æ‰¹å¤„ç†å¤§å°
   - ä½¿ç”¨GPUåŠ é€Ÿ

### è°ƒè¯•æ¨¡å¼

å¯ç”¨è°ƒè¯•æ¨¡å¼èŽ·å–è¯¦ç»†æ—¥å¿—ï¼š

```bash
python natural_language_agent.py --debug
```

æˆ–åœ¨ä»£ç ä¸­ï¼š

```python
from src import setup_logging

setup_logging(log_level="DEBUG", console_output=True)
```

## ðŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ä¼˜åŒ–
- å¯ç”¨åµŒå…¥ç¼“å­˜å‡å°‘é‡å¤è®¡ç®—
- å®šæœŸæ¸…ç†ç¼“å­˜é¿å…å†…å­˜æº¢å‡º
- è°ƒæ•´ç¼“å­˜TTLå’Œå¤§å°é™åˆ¶

### æœç´¢ä¼˜åŒ–
- è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼å¹³è¡¡å‡†ç¡®æ€§å’Œå¬å›žçŽ‡
- ä½¿ç”¨æ‰¹å¤„ç†æé«˜åžåé‡
- ä¼˜åŒ–æŸ¥è¯¢ç­–ç•¥æƒé‡

### ç¡¬ä»¶ä¼˜åŒ–
- ä½¿ç”¨GPUåŠ é€ŸåµŒå…¥è®¡ç®—
- å¢žåŠ å†…å­˜æé«˜ç¼“å­˜å‘½ä¸­çŽ‡
- ä½¿ç”¨SSDæé«˜I/Oæ€§èƒ½

## ðŸ“ æ—¥å¿—å’Œç›‘æŽ§

### æ—¥å¿—çº§åˆ«
- `DEBUG`: è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯
- `INFO`: ä¸€èˆ¬æ“ä½œä¿¡æ¯
- `WARNING`: è­¦å‘Šä¿¡æ¯
- `ERROR`: é”™è¯¯ä¿¡æ¯

### æ€§èƒ½ç›‘æŽ§

```python
from src import performance_monitor

# æŸ¥çœ‹æ€§èƒ½ç»Ÿè®¡
metrics = performance_monitor.get_metrics()
print(metrics)
```

## ðŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. åˆ›å»ºPull Request

## ðŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ã€‚

## ðŸ†˜ æ”¯æŒ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·ï¼š
1. æŸ¥çœ‹æ•…éšœæŽ’é™¤éƒ¨åˆ†
2. æ£€æŸ¥çŽ°æœ‰Issue
3. åˆ›å»ºæ–°Issueæè¿°é—®é¢˜
4. è”ç³»å¼€å‘å›¢é˜Ÿ